---
layout: post
title: Operating System——Virtual Memory
date: 2018-06-26
categories: blog
tags: Operating-System
description: Operating System
---

# 操作系统——虚拟存储器

## 前言

`操作系统原理`是武汉大学计算机学院软件工程专业大二下半学期所学习的一门专业课，教材为西安电子科技大学出版社的`计算机操作系统`第4版，这个专题的博客为该课程的学习笔记，该博客的主要内容是**虚拟存储器**

---
## 虚拟存储器的引入

常规存储器管理方式要求作业运行前全部装入内存，作业装入内存后一直驻留内存直至运行结束。 

这种存储管理方式不仅限制了大作业的运行，也不能满足大量作业同时运行的要求。而物理扩充内存会增加成本，故应从逻辑上扩充内存。

### 虚拟存储器的基本原理

在程序运行之前，将程序的一部分放入内存后就启动程序执行。

在程序执行过程中，当所访问的信息不在内存时，由操作系统将所需要的部分调入内存，然后继续执行程序。（请求调入）

另一方面，操作系统将内存中暂时不使用的内容换出到外存上，从而腾出空间存放将要调入内存的信息。（置换）

从效果上看，这样的计算机系统好像为用户提供了一个存储容量比实际内存大得多的存储器，将这个存储器称为虚拟存储器。（内存扩充）

### 虚拟存储器

虚拟存储器：虚拟存储器是指具有请求调入和置换功能，能从逻辑上对内存容量加以扩充的一种存储器系统。

**虚拟存储器的特征：多次性（最重要）、对换性、虚拟性（表现出来的最重要）**

虚拟存储器的理论基础是程序执行时的局部性原理。

局部性原理是指程序在执行过程中一个较短时间内，程序所执行的指令地址和操作数地址分别局限于一定区域内。

局部性体现为：
- 时间局部性：一条指令的一次执行和下次执行，一个数据的一次访问和下次访问，都集中在一个较短时间内。（例如：循环结构）
- 空间局部性：当前执行的指令和将要执行的指令，当前访问的数据和将要访问的数据，都集中在一个较小范围内。（例如：顺序执行）

#### 实现虚拟存储技术的物质基础
- 相当数量的外存：足以存放多个用户的程序。
- 一定容量的内存：在处理机上运行的程序必须有一部分信息存放在内存中。
- 地址变换机构：动态实现逻辑地址到物理地址的变换。
#### 虚拟存储器的实现方法

常用的虚拟存储技术有：
- 请求分页系统
  - 在分页系统的基础上，增加了请求调页功能、页面置换功能而形成的页式虚拟存储系统。
  - 主要的硬件支持有：请求分页的页表机制、缺页中断机构、地址变换机构
- 请求分段系统
  - 在分段系统的基础上，增加了请求调段功能、分段置换功能而形成的段式虚拟存储系统。
  - 主要的硬件支持有：请求分段的段表机制、缺段中断机构、地址变换机构
  
## 请求分页存储管理

请求分页存储管理方法是在分页存储管理的基础上增加了请求调页和页面置换功能。

实现思想：在作业运行之前只装入当前需要的一部分页面便启动作业运行。在作业运行过程中，若发现所要访问的页面不在内存，便由硬件产生缺页中断，请求OS将缺页调入内存。若内存无空闲存储空间，则根据某种置换算法淘汰已在内存的某个页面，以腾出内存空间装入缺页。

### 硬件支持

除了一定容量的内存和外存，请求分页中的支持机构还有：

页表、缺页中断机构、地址变换机构

![](https://raw.githubusercontent.com/yaowenqing/blog.io/master/img/OS_60.png)

**缺页中断处理**：在请求分页系统中，当地址转换机构发现指令所访问的页不在内存时，便产生缺页中断，请求OS将缺页调入内存（必要时淘汰内存中已有页面）并修改页表。

![](https://raw.githubusercontent.com/yaowenqing/blog.io/master/img/OS_61.png)

如上图，产生了6次缺页中断

**地址变换**：请求分页存储管理系统的地址变换过程类似于分页存储管理，但当被访问页不在内存时应进行缺页中断处理。

![](https://raw.githubusercontent.com/yaowenqing/blog.io/master/img/OS_62.png)

### 请求分页中的内存分配

在为进程分配物理块时应确定:
- 进程需要的最少物理块数
- 进程的物理块数是固定还是可变（分配策略）
- 按什么原则为进程分配物理块数（分配算法）

1.进程需要的最少物理块数

最小物理块数是指能保证进程正常运行所需的最少物理块数，若小于此值进程无法运行。

最小物理块数由执行一条指令所涉及的页面数确定。

一般情况下：对于单地址指令
- 单地址指令且采用直接寻址，则所需最少物理块数为2。
- 若单地址指令且允许采用间接寻址，则所需最少物理块数为3。
- 某些功能较强的机器，指令及地址均跨两个页面，则最少需要4个（直接寻址）或6个（间接寻址）物理块。

2.进程的物理块数是固定还是可变（分配策略）

在选择分配物理块的策略和置换范围时，需要考虑以下几个因素：
- 系统的并发性和吞吐量：分配给每个进程的物理块越少，则驻留在内存的进程就越多，因而系统的并发性和吞吐量就越大。
- 缺页中断率：分配给进程的物理块较少，则缺页中断率较高；但当分配给进程的物理块超过一定数量后，再增加物理块对减少进程的缺页率没有明显影响。

3.分配策略：固定分配和可变分配。

置换范围：全局置换和局部置换。

将分配策略和置换范围组合可得如下三种策略：
- 固定分配局部置换
- 可变分配全局置换
- 可变分配局部置换。

物理块分配算法：平均分配算法、按比例分配算法、按优先级分配算法

### 页面调入策略

1. 何时调入页面 

- 预调页策略
  - 将一批相邻存放的页/预计可能很快用到的页预先调入内存。
  - 预测成功率低，主要用于进程首次调入时。
- 请求调页策略
  - 程序运行中需要访问的页不在内存时，由OS将所缺的页调入内存。
  - 广泛采用，但是系统开销大。
  
2. 从何处调入页面  
- 文件区
  - 用于存放文件
  - 采用离散分配方式。
- 对换区
  - 用于存放对换页面
  - 采用连续分配方式
  - 故对换区的磁盘I/O速度比文件区的高。      

## 页面置换算法

页面置换算法又称为页面淘汰算法，是用来选择换出页面的算法。

研究页面置换算法要考虑：
- 淘汰页面范围：是全局置换还是局部置换
- 页面分配：确定分配给进程的物理块数，有固定分配和可变分配

页面置换算法的选择：应有较低的页面置换频率

1.最佳置换算法（OPT）

选择将来最长时间不会使用的页面予以淘汰。

特点：因页面访问的未来顺序很难精确预测，该算法具有理论意义，可以用来评价其他算法的优劣。

2.先进先出算法（FIFO）

选择调入主存时间最长的页面予以淘汰。

理由：最早调入内存的页面，其不再被访问的可能性最大。

特点：该算法实现比较简单，对按线性顺序访问的程序比较合适，但可能产生异常现象。

Belady现象：在某些情况下，分配给进程的页面数增多，缺页次数反而增加。

原因：最先进入内存的页面可能是今后经常用到的页面。

3.最近最久未使用置换算法(LRU)

选择最近一段时间内最长时间没有被访问过的页面予以淘汰。

根据程序局部性原理，那些刚被使用过的页面，可能马上还要被使用，而在较长时间里未被使用的页面，可能不会马上使用到。

4.时钟（clock）置换算法

LRU算法需要较多硬件支持，实现成本较高，因此实际应用中往往采用LRU的近似算法。clock算法就是用得较多的一种LRU近似算法。

为每页设置一个访问位，再将内存中所有页面通过链接指针链成一个循环队列。

当某页首次调入内存时，将其访问位置1。

当某页被访问时，将其访问位置1。

![](https://raw.githubusercontent.com/yaowenqing/blog.io/master/img/OS_63.png)

### 改进的时钟算法

将一个修改过的页面换出需要写磁盘，其开销大于未修改页面。

为此在改进型时钟算法中应考虑页面修改情况。设A为访问位，M为修改位，将页面分为以下4种类型：
- 1类(A=0,M=0)：最近未被访问又未被修改——用于置换的最佳页；
- 2类(A=0,M=1)：最近未被访问但已被修改——不是很好，因为在置换之前需将页写出到磁盘；
- 3类(A=1,M=0)：最近已被访问但未被修改——它有可能很快又要被使用；
- 4类(A=1,M=1)：最近已被访问且已被修改——它有可能很快又要被使用，且置换之前需将页写出到磁盘。

第1步：从指针当前位置开始扫描循环队列，寻找A=0,M=0的页面，将满足条件的第一个页面作为淘汰页。

第2步：若第1步失败，则开始第2轮扫描，寻找A=0,M=1的页面，将满足条件的第一个页面作为淘汰页，并将所有经历过页面的访问位置0。

第3步：若第2步失败，则指针再次回到了开始位置，然后重复第1步，若仍失败则必须重复第2步。此时一定能找到淘汰页面。

特点：减少了磁盘I/O次数，但算法本身开销增加。

有效访问时间（Effective Access Time, EAT）是指访问存储器所需时间的平均值。

纯分页系统的EAT计算

假定内存的读写周期为m,访问快表(相联存储器)的时间为e,快表命中率为p,则

> EAT=p×(m+e) + (1-p)×(m+m+e) 

例如：m=100ns，e=20ns，p=90%，则EAT为: 0.9×(100＋20)＋0.1×(100+100+20) ＝130ns

对于请求分页系统，假设使用了快表，则CPU访问内存时有以下三种情况：
- 页面在内存且页表项在快表中：只需一次访问内存
- 页面在内存但页表项不在快表中：需两次访问内存
- 页面不在内存：缺页中断处理时间(由三部分组成：缺页中断服务时间、页面传送时间：包括读缺页和写置换页的时间、进程重新执行时间）

设内存读写周期为m，缺页中断处理时间为t，快表命中率为p，快表访问时间可以忽略，缺页中断率为f，则有效访问时间为：

> EAT = p×m + (1-p-f)×2m + f×t

例如：设p=0.8，m=100ns，t=10ms，则：

EAT = 0.8×0.1 + (1-0.8-f)×2×0.1 + f×10×1000 = 0.12+9999.8f（μs）

若f为0.001，则EAT为10.1198微秒，是没有缺页（f=0）时EAT值（0.12 μs ）的84倍。

若要求在缺页时EAT增加不超过10％，则必须满足

> 0.12+9999.8f < 0.12+0.012 → f  ≈ 0.0000012

影响缺页率的因素：
- 分配给进程的物理块数
  - 一般来讲，物理块数与缺页率成反比关系。
- 页面本身的大小
  - 一般来讲，页面较小缺页率小，页面增大缺页率增大然后又下降。
- 程序的编制方法
  - 好的程序结构可以降低缺页率
- 页面置换算法

## 抖动

抖动(Thrashing) ：如果运行进程的大部分时间都用于页面的换入/换出，而几乎不能完成任何有效的工作，则称此进程处于抖动状态。抖动又称为颠簸。

抖动分为：局部抖动和全局抖动

抖动产生的原因有：
- 进程分配的物理块太少
- 置换算法选择不当
- 全局置换使抖动传播

抖动的预防及解除:
- 为防止系统抖动，可采用局部置换策略限制抖动的传播。
- 一旦发现抖动，增加分配给相应进程的物理块或挂起一些进程。

选择挂起进程的条件
- 优先级最低：符合进程调度原则
- 发生缺页中断的进程：内存不含工作集，缺页时应阻塞
- 物理块数最少的进程：重新装入开销小
- 最后被激活的进程：工作集可能不在内存
- 最大的进程：可释放较多空间
- 剩余时间最长：有利于提高系统吞吐量

## 请求分段存储管理方式
请求分段系统的思想：请求分段存储管理系统基于分段存储管理，是在分段存储管理系统的基础上，增加了请求调段、分段置换功能所形成的一种虚拟存储系统。

在请求分段存储管理中，作业运行之前，只要求将当前需要的若干个分段装入主存，便可启动作业运行。在作业运行过程中，若所要访问的分段不在主存，则通过调段功能将其调入，同时还可以通过置换功能将暂时不用的分段换出到外存上，以便腾出内存空间

### 请求分段中的支持机构
请求分段的支持机构有：
- 段表
- 缺段中断机构
- 地址变换机构

段表结构：

![](https://raw.githubusercontent.com/yaowenqing/blog.io/master/img/OS_64.png)

**缺段中断处理**：在请求分段系统中，每当所访问的段不在内存时，便产生一个缺段中断信号，请求OS将所缺分段调入内存。

缺段中断与缺页中断类似，也是在指令执行期间产生和处理。

处理流程:

![](https://raw.githubusercontent.com/yaowenqing/blog.io/master/img/OS_65.png)

**动态地址变换** ：请求分段系统的地址变换是在分段系统地址变换的基础上形成的。

在地址变换过程中，若段在内存则判断其存取权限是否合法，若合法则从段表中取出该段在内存的起始地址，与段内位移相加形成访问内存的物理地址。

若段不在内存，则产生缺段中断信号，请求OS将缺段调入内存，然后修改段表，再利用段表进行地址变换。

![](https://raw.githubusercontent.com/yaowenqing/blog.io/master/img/OS_66.png)

### 段的共享与保护

为了实现分段共享，可在系统中设置一张共享段表，所有共享分段都在其中占有一表项。共享段表的格式如下：

![](https://raw.githubusercontent.com/yaowenqing/blog.io/master/img/OS_67.png)

**共享段的回收**：当某进程不再需要使用共享段时，应释放该段。此时应将该进程段表中共享段的对应表项撤消，并将count减1，若结果为0则需要系统回收共享段的物理内存及有关表项，否则仅取消该进程在共享段中的记录。

**分段保护**：分段保护有以下措施：
- 越界检查：用段表长度与逻辑地址中的段号比较，用段长与逻辑地址中的段内位移比较。
- 存取方式检查：存取方式字段规定了对本段的访问方式。
- 环保护结构：规定低编号环具有高优先权。操作系统核心处于0环，某些重要实用程序和操作系统服务处于中间环，一般应用程序占据外环。

